cxx = $CXX -std=c++17

cxxflags = $
  -DLOG_UEVENTS=0 $
  -Wall $
  -Wextra $
  -Wno-unused-parameter $
  -Werror $
  -Wthread-safety $
  -Wno-shift-op-parentheses $
  -Wno-bitwise-op-parentheses $
  -DINIT_FULL_SOURCES $
  -DINSTALL_DEBUG_POLICY_TO_SYSTEM_EXT=0 $
  -DALLOW_FIRST_STAGE_CONSOLE=1 $
  -DALLOW_LOCAL_PROP_OVERRIDE=1 $
  -DALLOW_PERMISSIVE_SELINUX=1 $
  -DREBOOT_BOOTLOADER_ON_PANIC=1 $
  -DWORLD_WRITABLE_KMSG=1 $
  -DDUMP_ON_UMOUNT_FAILURE=1 $
  -DSHUTDOWN_ZERO_TIMEOUT=1 $
  -Wno-c99-designator $
  -D_LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS

includes = $
  -Isystem/libbase/include $
  -Isystem/core/include $
  -Isystem/core/libprocessgroup/include $
  -Isystem/core/libprocessgroup/setup/include $
  -Iexternal/protobuf/src $
  -I$BUILDROOT/init/proto $
  -Isystem/bioniccompat/include $
  -Isystem/core/fs_mgr/include_fstab $
  -Isystem/core/libmodprobe/include $

#libs = -lbacktrace -lbase -lbootloader_message -lcutils -ldl -lext4_utils -lfs_mgr -lgsi -lhidl-gen-utils -lkeyutils -llog -llogwrap -llp -lprocessgroup -lprocessgroup_setup -lselinux -lutils
libs = -L$SYSROOT/lib -lbase -lcutils -ldl -llog

rule protoc
  command = out/tc/host/bin/protoc --cpp_out=lite:$BUILDROOT/init/proto --dependency_out=$out -I . $in #&& out/soong/host/linux-x86/bin/dep_fixer out/soong/.intermediates/system/core/init/host_init_verifier/linux_glibc_x86_64/gen/proto/system/core/init/subcontext.pb.d
build $BUILDROOT/init/proto/system/core/init/subcontext.pb.d | $BUILDROOT/init/proto/system/core/init/subcontext.pb.h $BUILDROOT/init/proto/system/core/init/subcontext.pb.cc: protoc system/core/init/subcontext.proto | out/tc/host/bin/protoc
build $BUILDROOT/init/proto/system/core/init/property_service.pb.d | $BUILDROOT/init/proto/system/core/init/property_service.pb.h $BUILDROOT/init/proto/system/core/init/property_service.pb.cc: protoc system/core/init/property_service.proto | out/tc/host/bin/protoc

build $BUILDROOT/init/obj/subcontext.pb.o: cxx $BUILDROOT/init/proto/system/core/init/subcontext.pb.cc
  cxxflags = $cxxflags -Wno-unused-command-line-argument

# init_common_sources = [
build $BUILDROOT/init/obj/action.o: cxx system/core/init/action.cpp
build $BUILDROOT/init/obj/action_manager.o: cxx system/core/init/action_manager.cpp
build $BUILDROOT/init/obj/action_parser.o: cxx system/core/init/action_parser.cpp
build $BUILDROOT/init/obj/capabilities.o: cxx system/core/init/capabilities.cpp
build $BUILDROOT/init/obj/epoll.o: cxx system/core/init/epoll.cpp
build $BUILDROOT/init/obj/import_parser.o: cxx system/core/init/import_parser.cpp
build $BUILDROOT/init/obj/interface_utils.o: cxx system/core/init/interface_utils.cpp
build $BUILDROOT/init/obj/keychords.o: cxx system/core/init/keychords.cpp
build $BUILDROOT/init/obj/parser.o: cxx system/core/init/parser.cpp
build $BUILDROOT/init/obj/property_type.o: cxx system/core/init/property_type.cpp
build $BUILDROOT/init/obj/rlimit_parser.o: cxx system/core/init/rlimit_parser.cpp
build $BUILDROOT/init/obj/service.o: cxx system/core/init/service.cpp
build $BUILDROOT/init/obj/service_list.o: cxx system/core/init/service_list.cpp
build $BUILDROOT/init/obj/service_parser.o: cxx system/core/init/service_parser.cpp
build $BUILDROOT/init/obj/service_utils.o: cxx system/core/init/service_utils.cpp
build $BUILDROOT/init/obj/subcontext.o: cxx system/core/init/subcontext.cpp
build $BUILDROOT/init/obj/tokenizer.o: cxx system/core/init/tokenizer.cpp
build $BUILDROOT/init/obj/util.o: cxx system/core/init/util.cpp
# init_device_sources = [
build $BUILDROOT/init/obj/block_dev_initializer.o: cxx system/core/init/block_dev_initializer.cpp
build $BUILDROOT/init/obj/bootchart.o: cxx system/core/init/bootchart.cpp
build $BUILDROOT/init/obj/builtins.o: cxx system/core/init/builtins.cpp
build $BUILDROOT/init/obj/devices.o: cxx system/core/init/devices.cpp
build $BUILDROOT/init/obj/firmware_handler.o: cxx system/core/init/firmware_handler.cpp
build $BUILDROOT/init/obj/first_stage_console.o: cxx system/core/init/first_stage_console.cpp
build $BUILDROOT/init/obj/first_stage_init.o: cxx system/core/init/first_stage_init.cpp
build $BUILDROOT/init/obj/first_stage_mount.o: cxx system/core/init/first_stage_mount.cpp
build $BUILDROOT/init/obj/fscrypt_init_extensions.o: cxx system/core/init/fscrypt_init_extensions.cpp
build $BUILDROOT/init/obj/init.o: cxx system/core/init/init.cpp | $BUILDROOT/init/proto/system/core/init/property_service.pb.h
build $BUILDROOT/init/obj/lmkd_service.o: cxx system/core/init/lmkd_service.cpp
build $BUILDROOT/init/obj/modalias_handler.o: cxx system/core/init/modalias_handler.cpp
build $BUILDROOT/init/obj/mount_handler.o: cxx system/core/init/mount_handler.cpp
build $BUILDROOT/init/obj/mount_namespace.o: cxx system/core/init/mount_namespace.cpp
build $BUILDROOT/init/obj/persistent_properties.o: cxx system/core/init/persistent_properties.cpp
build $BUILDROOT/init/obj/persistent_properties.pr.o: cxx system/core/init/persistent_properties.proto
build $BUILDROOT/init/obj/property_service.o: cxx system/core/init/property_service.cpp
build $BUILDROOT/init/obj/property_service.pr.o: cxx system/core/init/property_service.proto
build $BUILDROOT/init/obj/reboot.o: cxx system/core/init/reboot.cpp
build $BUILDROOT/init/obj/reboot_utils.o: cxx system/core/init/reboot_utils.cpp
build $BUILDROOT/init/obj/security.o: cxx system/core/init/security.cpp
build $BUILDROOT/init/obj/selabel.o: cxx system/core/init/selabel.cpp
build $BUILDROOT/init/obj/selinux.o: cxx system/core/init/selinux.cpp
build $BUILDROOT/init/obj/sigchld_handler.o: cxx system/core/init/sigchld_handler.cpp
build $BUILDROOT/init/obj/snapuserd_transition.o: cxx system/core/init/snapuserd_transition.cpp
build $BUILDROOT/init/obj/switch_root.o: cxx system/core/init/switch_root.cpp
build $BUILDROOT/init/obj/uevent_listener.o: cxx system/core/init/uevent_listener.cpp
build $BUILDROOT/init/obj/ueventd.o: cxx system/core/init/ueventd.cpp
build $BUILDROOT/init/obj/ueventd_parser.o: cxx system/core/init/ueventd_parser.cpp

build $BUILDROOT/init/obj/libinit.a: ar $
  $BUILDROOT/init/obj/init.o $
  $BUILDROOT/init/obj/ueventd.o $
  $BUILDROOT/init/obj/subcontext.pb.o

# init_second_stage
build $BUILDROOT/init/obj/main.o: cxx system/core/init/main.cpp | $SYSROOT/include/sys/capability.h $BUILDROOT/init/proto/system/core/init/subcontext.pb.h

build $BUILDROOT/init/obj/init: link $BUILDROOT/init/obj/libinit.a $BUILDROOT/init/obj/main.o $
  | $SYSROOT/lib/libbase.so $SYSROOT/lib/libcutils.so $SYSROOT/lib/liblog.so

# symlink init as ueventd

# init_first_stage ...

